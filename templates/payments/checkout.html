{% extends 'base.html' %}
{% load static %}
{% block title %}{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/stripe.css' %}" />
<script src="https://js.stripe.com/v3/"></script>
{% endblock extra_head %}

{% block navbar %}
    {% include 'components/navbar.html' %}
{% endblock navbar %}


{% block content %}

<!-- component -->
<div class="w-full my-20 z-50 sticky  rounded-3xl px-6 dark:bg-zinc-900">

    <div class="px-4 py-16 mx-auto sm:max-w-xl md:max-w-full lg:max-w-screen-xl md:px-24 lg:px-8 lg:py-20">
        
          <div class="flex flex-col items-center justify-between w-full mb-10 lg:flex-row">
            <div class="mb-16 lg:mb-0 lg:max-w-lg lg:pr-5">
              <div class="max-w-xl mb-6">
                
                <h2 class="font-sans text-3xl font-bold tracking-tight text-white sm:text-4xl sm:leading-none max-w-lg mb-6">
                 Aprende con el plan {{pricing_tier.name}}
                </h2>
                <p class="text-white text-base md:text-lg"> Lorem Ipsum is so cool and awesome to act and so cool to think. And very awesome to eat and talk.
                </p>
              </div>
              <div class="flex items-center space-x-3">

                <ul class="flex-1 space-y-4">
                      <li class="flex items-start">
                        <svg
                             class="w-6 h-6 text-green-300"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             >
                          <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"
                                />
                        </svg>
                        <span class="ml-3 text-base font-medium text-white" >Acceso a +10 cursos</span>
                      </li>
                      <li class="flex items-start">
                        <svg
                             class="w-6 h-6 text-green-300"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             >
                          <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"
                                />
                        </svg>
                        <span class="ml-3 text-base font-medium text-white" >Certificado al finalizar</span>
                      </li>
                      <li class="flex items-start">
                        <svg
                             class="w-6 h-6 text-green-300"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             >
                          <path
                                fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                clip-rule="evenodd"
                                />
                        </svg>
                        <span class="ml-3 text-base font-medium text-white" >Recursos</span>
                      </li>
                  </ul>

              </div>
            </div>
                <Image alt="logo" width=550 height=550 src="{% static 'img/11.png' %}" />
          </div>
        </div>
    
    
    
        <div class="px-4 py-16 mx-auto sm:max-w-xl md:max-w-full lg:max-w-screen-xl md:px-24 lg:px-8 lg:py-20">
          <div class="flex flex-col items-center justify-between w-full mb-10 lg:flex-row">
            
          <Image alt="logo" width=450 height=450 src="{% static 'img/ha.png' %}" />
    
    
            <div class="mb-16 lg:mb-0 lg:max-w-lg lg:pr-5">
              
              <div class="max-w-xl mb-6">
                
                <h2 class="font-sans text-3xl sm:mt-0 mt-6 font-bold tracking-tight text-white sm:text-4xl sm:leading-none max-w-lg mb-6">
                 $ {{pricing_tier.price}}/mo
                </h2>
                <p class="text-white text-base md:text-lg">Lorem Ipsum is so cool and awesome to act and so cool to think. And very awesome to eat and talk.
    
                </p>
              </div>
              <div class="flex items-center space-x-3">
              <form id="subscription-form">
                {% csrf_token %}
                <div id="card-element"><!--Stripe.js injects the Card Element--></div>
                <button id="submit" type="submit" class="flex object-cover sm:mr-64 mr-32 object-top items-center text-white border border-2 justify-center w-full sm:px-10 py-4 leading-6 bg-black rounded-lg font-black">
                    <div class="spinner hidden" id="spinner"></div>
                    <span id="button-text">Buy Now</span>
                </button>
    </form>
    
              </div>
              <figcaption class="mt-3 flex text-sm text-gray-500">
                <!-- Heroicon name: solid/camera -->
  
                <svg xmlns="http://www.w3.org/2000/svg" class="flex-none w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span class="ml-2 cursor-default">Payment Secured by Stripe</span>
              </figcaption>
            </figure>
            </div>
          </div>
        </div>
    

    
    

    
    
    

          </div>
        </div>
      
              </div>


{% endblock content %}


{% block footer %}

{% endblock footer %}


{% block javascript %}
<script>

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
    var stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
    var elements = stripe.elements();
  
    // Set up Stripe.js and Elements to use in checkout form
    var style = {
      base: {
        color: "#32325d",
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: "antialiased",
        fontSize: "16px",
        "::placeholder": {
          color: "#aab7c4"
        }
      },
      invalid: {
        color: "#fa755a",
        iconColor: "#fa755a"
      }
    };
  
    var priceId = "{{ pricing_tier.stripe_price_id }}"
  
    var card = elements.create("card", { style: style });
    card.mount("#card-element");
  
    card.on('change', showCardError);
  
    function showCardError(event) {
      let displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    }
  
    var form = document.getElementById('subscription-form');
  
    form.addEventListener('submit', function (ev) {
      ev.preventDefault();
      changeLoadingState(true);
  
      // If a previous payment was attempted, get the latest invoice
      const latestInvoicePaymentIntentStatus = localStorage.getItem(
        'latestInvoicePaymentIntentStatus'
      );
  
      if (latestInvoicePaymentIntentStatus === 'requires_payment_method') {
        const invoiceId = localStorage.getItem('latestInvoiceId');
        const isPaymentRetry = true;
        // create new payment method & retry payment on invoice with new payment method
        createPaymentMethod({
          card,
          isPaymentRetry,
          invoiceId,
        });
      } else {
        // create new payment method & create subscription
        createPaymentMethod({ card });
      }
    });
  
    function createPaymentMethod({ card, isPaymentRetry, invoiceId }) {
      // Set up payment method for recurring usage
  
      stripe
        .createPaymentMethod({
          type: 'card',
          card: card,
        })
        .then((result) => {
          if (result.error) {
            changeLoadingState(false);
            displayError(result);
          } else {
            if (isPaymentRetry) {
              // Update the payment method and retry invoice payment
              retryInvoiceWithNewPaymentMethod({
                paymentMethodId: result.paymentMethod.id,
                invoiceId: invoiceId,
                priceId: priceId,
              });
            } else {
              // Create the subscription
              createSubscription({
                paymentMethodId: result.paymentMethod.id,
                priceId: priceId,
              });
            }
          }
        });
    }
  
    function createSubscription({ paymentMethodId, priceId }) {
      return (
        fetch("{% url 'payment:create-subscription' %}", {
          method: 'post',
          headers: {
            'Content-Type': "application/json",
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            paymentMethodId: paymentMethodId,
            priceId: priceId,
          }),
        })
          .then((response) => {
            return response.json();
          })
          // If the card is declined, display an error to the user.
          .then((result) => {
            if (result.error) {
              // The card had an error when trying to attach it to a customer.
              throw result;
            }
            return result;
          })
          // Normalize the result to contain the object returned by Stripe.
          // Add the additional details we need.
          .then((result) => {
            return {
              paymentMethodId: paymentMethodId,
              priceId: priceId,
              subscription: result,
            };
          })
          // Some payment methods require a customer to be on session
          // to complete the payment process. Check the status of the
          // payment intent to handle these actions.
          .then(handlePaymentThatRequiresCustomerAction)
          // If attaching this card to a Customer object succeeds,
          // but attempts to charge the customer fail, you
          // get a requires_payment_method error.
          .then(handleRequiresPaymentMethod)
          // No more actions required. Provision your service for the user.
          .then(onSubscriptionComplete)
          .catch((error) => {
            changeLoadingState(false);
            // An error has happened. Display the failure to the user here.
            // We utilize the HTML element we created.
            showCardError(error);
          })
      );
    }
  
    function handlePaymentThatRequiresCustomerAction({
      subscription,
      invoice,
      priceId,
      paymentMethodId,
      isRetry,
    }) {
      if (subscription && subscription.status === 'active') {
        // Subscription is active, no customer actions required.
        return { subscription, priceId, paymentMethodId };
      }
  
      // If it's a first payment attempt, the payment intent is on the subscription latest invoice.
      // If it's a retry, the payment intent will be on the invoice itself.
      let paymentIntent = invoice ? invoice.payment_intent : subscription.latest_invoice.payment_intent;
  
      if (
        paymentIntent.status === 'requires_action' ||
        (isRetry === true && paymentIntent.status === 'requires_payment_method')
      ) {
        return stripe
          .confirmCardPayment(paymentIntent.client_secret, {
            payment_method: paymentMethodId,
          })
          .then((result) => {
            if (result.error) {
              // Start code flow to handle updating the payment details.
              // Display error message in your UI.
              // The card was declined (i.e. insufficient funds, card has expired, etc).
              throw result;
            } else {
              if (result.paymentIntent.status === 'succeeded') {
                // Show a success message to your customer.
                // There's a risk of the customer closing the window before the callback.
                // We recommend setting up webhook endpoints later in this guide.
                return {
                  priceId: priceId,
                  subscription: subscription,
                  invoice: invoice,
                  paymentMethodId: paymentMethodId,
                };
              }
            }
          })
          .catch((error) => {
            changeLoadingState(false);
            displayError(error);
          });
      } else {
        // No customer action needed.
        return { subscription, priceId, paymentMethodId };
      }
    }
  
    function handleRequiresPaymentMethod({
      subscription,
      paymentMethodId,
      priceId,
    }) {
      if (subscription.status === 'active') {
        // subscription is active, no customer actions required.
        return { subscription, priceId, paymentMethodId };
      } else if (
        subscription.latest_invoice.payment_intent.status ===
        'requires_payment_method'
      ) {
        // Using localStorage to manage the state of the retry here,
        // feel free to replace with what you prefer.
        // Store the latest invoice ID and status.
        localStorage.setItem('latestInvoiceId', subscription.latest_invoice.id);
        localStorage.setItem(
          'latestInvoicePaymentIntentStatus',
          subscription.latest_invoice.payment_intent.status
        );
        throw { error: { message: 'Your card was declined.' } };
      } else {
        return { subscription, priceId, paymentMethodId };
      }
    }
  
    function onSubscriptionComplete(result) {
      // Payment was successful.
      if (result.subscription.status === 'active') {
          console.log("Complete")
          window.location.href = "{% url 'payment:thank-you' %}"
        // Change your UI to show a success message to your customer.
        // Call your backend to grant access to your service based on
        // `result.subscription.items.data[0].price.product` the customer subscribed to.
      }
    }
  
    function retryInvoiceWithNewPaymentMethod({
      paymentMethodId,
      invoiceId,
      priceId
    }) {
      return (
        fetch("{% url 'payment:retry-invoice' %}", {
          method: 'post',
          headers: {
            'Content-Type': "application/json",
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            paymentMethodId: paymentMethodId,
            invoiceId: invoiceId,
          }),
        })
          .then((response) => {
            return response.json();
          })
          // If the card is declined, display an error to the user.
          .then((result) => {
            if (result.error) {
              // The card had an error when trying to attach it to a customer.
              throw result;
            }
            return result;
          })
          // Normalize the result to contain the object returned by Stripe.
          // Add the additional details we need.
          .then((result) => {
            return {
              // Use the Stripe 'object' property on the
              // returned result to understand what object is returned.
              invoice: result,
              paymentMethodId: paymentMethodId,
              priceId: priceId,
              isRetry: true,
            };
          })
          // Some payment methods require a customer to be on session
          // to complete the payment process. Check the status of the
          // payment intent to handle these actions.
          .then(handlePaymentThatRequiresCustomerAction)
          // No more actions required. Provision your service for the user.
          .then(onSubscriptionComplete)
          .catch((error) => {
            changeLoadingState(false);
            // An error has happened. Display the failure to the user here.
            // We utilize the HTML element we created.
            displayError(error);
          })
      );
    }
  
    function changeLoadingState(isLoading) {
      if (isLoading) {
        document.querySelector('#button-text').classList.add('hidden');
        document.querySelector('#spinner').classList.remove('hidden');
        document.querySelector('#subscription-form button').disabled = true;
      } else {
        document.querySelector('#button-text').classList.remove('hidden');
        document.querySelector('#spinner').classList.add('hidden');
        document.querySelector('#subscription-form button').disabled = false;
      }
    }
  
  </script>
{% endblock javascript %}